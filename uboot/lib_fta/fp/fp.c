/*****************************************************************************

File name   :  fp.c

Description :  small FP driver

 COPYRIGHT (C) FTA Communication technologies 2007.

Date               Modification                                          Name
----               ------------                                          ----
07/04/08           Created                                               FR

*****************************************************************************/
/* --- include ------------------------------------------------------------ */
#include <asm/soc.h>

#include "fta/definition.h"
#include "../iboot/iboot.h"

typedef struct
{
    U8   (*read) (void);
    void (*write)(const I8 *text);
} fp_dev_t;

static fp_dev_t fp = {
    .read  = NULL,
    .write = NULL
};

#if defined(CONFIG_SOFT_SPI) && defined(CONFIG_SH4)
static const U16 font_16seg[] =
{           /*          fedc ba98 7654 3210 */
    0x0000, /* sp  032  0000 0000 0000 0000 */
    0x0088, /* !   033  0000 0000 1000 1000 */
    0x000A, /* ""  034  0000 0000 0000 1010 */
    0xE9E8, /* #   035  1110 1001 1110 1000 */
    0x69cb, /* $   036  0110 1001 1100 1011 */
    0x6ddb, /* %   037  0110 1101 1101 1011 */
    0x56d6, /* &   038  0101 0110 1101 0110 */
    0x0008, /* '   039  0000 0000 0000 1000 */
    0x1010, /* (   040  0001 0000 0001 0000 */
    0x0404, /* )   041  0000 0100 0000 0100 */
    0x1d5c, /* *   042  0001 1101 0101 1100 */
    0x09c8, /* +   043  0000 1001 1100 1000 */
    0x8000, /* ,   044  1000 0000 0000 0000 */
    0x01C0, /* -   045  0000 0001 1100 0000 */
    0x8000, /* .   046  1000 0000 0000 0000 */
    0x0490, /* /   047  0000 0100 1001 0000 */
    0x6223, /* 0   048  0110 0010 0010 0011 */
    0x2030, /* 1   049  0010 0000 0011 0000 */
    0x43e1, /* 2   050  0100 0011 1110 0001 */
    0x61a1, /* 3   051  0110 0001 1010 0001 */
    0x21e2, /* 4   052  0010 0001 1110 0010 */
    0x61c3, /* 5   053  0110 0001 1100 0011 */
    0x63c3, /* 6   054  0110 0011 1100 0011 */
    0x0491, /* 7   055  0000 0100 1001 0001 */
    0x63e3, /* 8   056  0110 0011 1110 0011 */
    0x61e3, /* 9   057  0110 0001 1110 0011 */
    0x4080, /* :   058  0100 0000 1000 0000 */
    0x8000, /* ;   059  1000 0000 0000 0000 */
    0x1090, /* <   060  0001 0000 1001 0000 */
    0x41c0, /* =   061  0100 0001 1100 0000 */
    0x0484, /* >   062  0000 0100 1000 0100 */
    0x09a3, /* ?   063  0000 1001 1010 0011 */
    0xeb83, /* @   064  1110 1011 1000 0011 */
    0x23e3, /* A   065  0010 0011 1110 0011 */
    0x52d3, /* B   066  0101 0010 1101 0011 */
    0x4203, /* C   067  0100 0010 0000 0011 */
    0x68a9, /* D   068  0110 1000 1010 1001 */
    0x42c3, /* E   069  0100 0010 1100 0011 */
    0x02c3, /* F   070  0000 0010 1100 0011 */
    0x6303, /* G   071  0110 0011 0000 0011 */
    0x23e2, /* H   072  0010 0011 1110 0010 */
    0x4889, /* I   073  0100 1000 1000 1001 */
    0x6220, /* J   074  0110 0010 0010 0000 */
    0x12D2, /* K   075  0001 0010 1101 0010 */
    0x4202, /* L   076  0100 0010 0000 0010 */
    0x2236, /* M   077  0010 0010 0011 0110 */
    0x3226, /* N   078  0011 0010 0010 0110 */
    0x6223, /* O   079  0110 0010 0010 0011 */
    0x03e3, /* P   080  0000 0011 1110 0011 */
    0xe223, /* Q   081  1110 0010 0010 0011 */
    0x13e3, /* R   082  0001 0011 1110 0011 */
    0x61c3, /* S   083  0110 0001 1100 0011 */
    0x0889, /* T   084  0000 1000 1000 1001 */
    0x6222, /* U   085  0110 0010 0010 0010 */
    0x0692, /* V   086  0000 0110 1001 0010 */
    0x3622, /* W   087  0011 0110 0010 0010 */
    0x1494, /* X   088  0001 0100 1001 0100 */
    0x0894, /* Y   089  0000 1000 1001 0100 */
    0x4491, /* Z   090  0100 0100 1001 0001 */
    0x4203, /* [   091  0100 0010 0000 0011 */
    0x1084, /*  \  092  0001 0000 1000 0100 */
    0x6021, /* ]   093  0110 0000 0010 0001 */
    0x1480, /* ^   094  0001 0100 1000 0000 */
    0x4000, /* _   095  0100 0000 0000 0000 */
    0x0004, /* `   096  0000 0000 0000 0100 */
    0x23e3, /* A   065  0010 0011 1110 0011 */
    0x52d3, /* B   066  0101 0010 1101 0011 */
    0x4203, /* C   067  0100 0010 0000 0011 */
    0x68a9, /* D   068  0110 1000 1010 1001 */
    0x42c3, /* E   069  0100 0010 1100 0011 */
    0x02c3, /* F   070  0000 0010 1100 0011 */
    0x6303, /* G   071  0110 0011 0000 0011 */
    0x23e2, /* H   072  0010 0011 1110 0010 */
    0x4889, /* I   073  0100 1000 1000 1001 */
    0x6220, /* J   074  0110 0010 0010 0000 */
    0x12D2, /* K   075  0001 0010 1101 0010 */
    0x4202, /* L   076  0100 0010 0000 0010 */
    0x2236, /* M   077  0010 0010 0011 0110 */
    0x3226, /* N   078  0011 0010 0010 0110 */
    0x6223, /* O   079  0110 0010 0010 0011 */
    0x03e3, /* P   080  0000 0011 1110 0011 */
    0xe223, /* Q   081  1110 0010 0010 0011 */
    0x13e3, /* R   082  0001 0011 1110 0011 */
    0x61c3, /* S   083  0110 0001 1100 0011 */
    0x0889, /* T   084  0000 1000 1000 1001 */
    0x6222, /* U   085  0110 0010 0010 0010 */
    0x0692, /* V   086  0000 0110 1001 0010 */
    0x3622, /* W   087  0011 0110 0010 0010 */
    0x1494, /* X   088  0001 0100 1001 0100 */
    0x0894, /* Y   089  0000 1000 1001 0100 */
    0x4491, /* Z   090  0100 0100 1001 0001 */
    0x10d0, /* {   123  0001 0000 1101 0000 */
    0x0202, /* |   124  0000 0010 0000 0010 */
    0x0584, /* }   125  0000 0101 1000 0100 */
    0x0186, /* ~   126  0000 0001 1000 0110 */
    0xffff, /*     127  1111 1111 1111 1111 */
};

static const U8 item_7led [] =
{
    0, 2,   /*   0 semi column   */
    4,11,   /*   1 green led     */
};

static const U16 font_7led[] =
{           /*          fedc ba98 7654 3210 */
    0x0000, /* sp  032  0000 0000 0000 0000 */
    0x0102, /* !   033  0000 0001 0000 0010 */
    0x0012, /* ""  034  0000 0000 0001 0010 */
    0x033A, /* #   035  0000 0011 0011 1010 */
    0x032b, /* $   036  0000 0011 0010 1011 */
    0x03FF, /* %   037  0000 0011 1111 1111 */
    0x03EF, /* &   038  0000 0011 1110 1111 */
    0x0002, /* '   039  0000 0000 0000 0010 */
    0x0123, /* (   040  0000 0001 0010 0011 */
    0x0231, /* )   041  0000 0010 0011 0001 */
    0x031A, /* *   042  0000 0011 0001 1010 */
    0x010A, /* +   043  0000 0001 0000 1010 */
    0x0100, /* ,   044  0000 0001 0000 0000 */
    0x0008, /* -   045  0000 0000 0000 1000 */
    0x0020, /* .   046  0000 0000 0010 0000 */
    0x0118, /* /   047  0000 0001 0001 1000 */
    0x0333, /* 0   048  0000 0011 0011 0011 */
    0x0210, /* 1   049  0000 0010 0001 0000 */
    0x0139, /* 2   050  0000 0001 0011 1001 */
    0x0239, /* 3   051  0000 0010 0011 1001 */
    0x021A, /* 4   052  0000 0010 0001 1010 */
    0x022B, /* 5   053  0000 0010 0010 1011 */
    0x032B, /* 6   054  0000 0011 0010 1011 */
    0x0211, /* 7   055  0000 0010 0001 0001 */
    0x03FF, /* 8   056  0000 0011 1111 1111 */
    0x02FF, /* 9   057  0000 0010 1111 1111 */
    0x0024, /* :   058  0000 0000 0010 0100 */
    0x0024, /* ;   059  0000 0000 0010 0100 */
    0x0218, /* <   060  0000 0010 0001 1000 */
    0x0024, /* =   061  0000 0000 0010 0100 */
    0x010A, /* >   062  0000 0001 0000 1010 */
    0x0213, /* ?   063  0000 0010 0001 0011 */
    0x03FF, /* @   064  0000 0011 1111 1111 */
    0x03DF, /* A   065  0000 0011 1101 1111 */
    0x032A, /* B   066  0000 0011 0010 1010 */
    0x0128, /* C   067  0000 0001 0010 1000 */
    0x0338, /* D   068  0000 0011 0011 1000 */
    0x012B, /* E   069  0000 0001 0010 1011 */
    0x010B, /* F   070  0000 0001 0000 1011 */
    0x023B, /* G   071  0000 0010 0011 1011 */
    0x030A, /* H   072  0000 0011 0000 1010 */
    0x0100, /* I   073  0000 0001 0000 0000 */
    0x0330, /* J   074  0000 0011 0011 0000 */
    0x030A, /* K   075  0000 0011 0000 1010 */
    0x0122, /* L   076  0000 0001 0010 0010 */
    0x0313, /* M   077  0000 0011 0001 0011 */
    0x0308, /* N   078  0000 0011 0000 1000 */
    0x0328, /* O   079  0000 0011 0010 1000 */
    0x011B, /* P   080  0000 0001 0001 1011 */
    0x021B, /* Q   081  0000 0010 0001 1011 */
    0x0108, /* R   082  0000 0001 0000 1000 */
    0x022B, /* S   083  0000 0010 0010 1011 */
    0x012A, /* T   084  0000 0001 0010 1010 */
    0x0320, /* U   085  0000 0011 0010 0000 */
    0x0320, /* V   086  0000 0011 0010 0000 */
    0x0332, /* W   087  0000 0011 0011 0010 */
    0x031A, /* X   088  0000 0011 0001 1010 */
    0x021A, /* Y   089  0000 0010 0001 1010 */
    0x0139, /* Z   090  0000 0001 0011 1001 */
    0x0123, /* [   091  0000 0001 0010 0011 */
    0x020A, /*  \  092  0000 0010 0000 1010 */
    0x0231, /* ]   093  0000 0010 0011 0001 */
    0x0001, /* ^   094  0000 0000 0000 0001 */
    0x0020, /* _   095  0000 0000 0010 0000 */
    0x0002, /* `   096  0000 0000 0000 0010 */
    0x03DF, /* A   097  0000 0011 1101 1111 */
    0x032A, /* B   098  0000 0011 0010 1010 */
    0x0128, /* C   099  0000 0001 0010 1000 */
    0x0338, /* D   100  0000 0011 0011 1000 */
    0x012B, /* E   101  0000 0001 0010 1011 */
    0x010B, /* F   102  0000 0001 0000 1011 */
    0x023B, /* G   103  0000 0010 0011 1011 */
    0x030A, /* H   104  0000 0011 0000 1010 */
    0x0100, /* I   105  0000 0001 0000 0000 */
    0x0330, /* J   106  0000 0011 0011 0000 */
    0x030A, /* K   107  0000 0011 0000 1010 */
    0x0122, /* L   108  0000 0001 0010 0010 */
    0x0313, /* M   109  0000 0011 0001 0011 */
    0x0308, /* N   110  0000 0011 0000 1000 */
    0x0328, /* O   111  0000 0011 0010 1000 */
    0x011B, /* P   112  0000 0001 0001 1011 */
    0x021B, /* Q   113  0000 0010 0001 1011 */
    0x0108, /* R   114  0000 0001 0000 1000 */
    0x022B, /* S   115  0000 0010 0010 1011 */
    0x012A, /* T   116  0000 0001 0010 1010 */
    0x0320, /* U   117  0000 0011 0010 0000 */
    0x0320, /* V   118  0000 0011 0010 0000 */
    0x0332, /* W   119  0000 0011 0011 0010 */
    0x031A, /* X   120  0000 0011 0001 1010 */
    0x021A, /* Y   121  0000 0010 0001 1010 */
    0x0139, /* Z   122  0000 0001 0011 1001 */
    0x0218, /* {   123  0000 0010 0001 1000 */
    0x0210, /* |   124  0000 0010 0001 0000 */
    0x010A, /* }   125  0000 0001 0000 1010 */
    0x0001, /* ~   126  0000 0000 0000 0001 */
    0x03FF, /*     127  0000 0011 1111 1111 */
};

static U32 matrix[8]; /* shadow of the 8 display segments */

/* ========================================================================
   Name:        sendBytes
   Description: Send a burst of data to FP display

   ======================================================================== */
static void sendBytes( U8 *Bytes, U32 Number )
{
    U8 i;
    U8 j;

    SPI_CS(0);
    SPI_DELAY;
    for( i = 0; i < Number; i++,Bytes++ )
    {
        for( j = 0; j < 8; j++ )
        {
            SPI_SCL(0);
            SPI_DELAY;
            SPI_SDA((*Bytes>>j) & 1);
            SPI_SCL(1);
            SPI_DELAY;
        }
    }
    SPI_CS(1);
    SPI_DELAY;
}


/* ========================================================================
   Name:        sendCommand
   Description: send command to fp controller

   ======================================================================== */
static void sendCommand( U8 command )
{
    sendBytes (&command, 1 );
}

/* ========================================================================
   Name:        set_item_7led
   Description: Enables/disables a specific item on the FP display

   ======================================================================== */
static void set_item_7led( I32 item , I32 onoff )
{
    U8 digit;
    U8 num;
    U8 command[4];

    if ( item < 2 )
    {
        digit = item_7led[(item<<1)+0];
        num   = item_7led[(item<<1)+1];
        if (onoff)
        {
            matrix[digit] |=  (1<<num);     /* set bit in RAM */
        }
        else
        {
            matrix[digit] &=  ~(1<<num);    /* clear bit in RAM */
        }
        command[0] = 0xc0 | (2*digit);
        command[1] = (matrix[digit]>>0 ) &0xff;
        command[2] = (matrix[digit]>>8 ) &0xff;
    }
    sendCommand(0x40);                      /* write to display RAM */
    sendBytes  (&command[0], 3);            /* write to character memory */
}

/* ========================================================================
   Name:        write_16seg
   Description: write text to FP display ( no scrolling permitted )

   ======================================================================== */
static void write_16seg( const I8 *text )
{
    U8 i;
    U8 term=0;
    U8 data[25];

    data[0] = 0xC0;
    for (i=0;i<8;i++)
    {
        if ( *text==0)
        {
            term =1;
        }
        matrix[i] = ( matrix[i] & 0xffff0000 ) | (term==1? 0 : font_16seg [(*text-32)]);
        data[1+(i*3)] = (matrix[i]>>0 )&0xFF;
        data[2+(i*3)] = (matrix[i]>>8 )&0xFF;
        data[3+(i*3)] = (matrix[i]>>16)&0xFF;
        text++;
    }
    sendCommand(0x40);                      /* write to display RAM */
    sendBytes  (data, 25);                  /* update ram content */
}

/* ========================================================================
   Name:        write_16seg
   Description: write text to FP display ( no scrolling permitted )

   ======================================================================== */
static void write_7led( const I8 *text )
{
    U8 i;
    U8 term=0;
    U8 data[11];
    U8 lookup[5] = { 0,2,3,1,4 };

    data[0] = 0xC0;
    data[1] = (matrix[0] >>0 )&0xFF;        /* first digit corresponds to semi column */
    data[2] = (matrix[1] >>8 )&0xFF;        /* first digit corresponds to semi column */
    for (i=1;i<5;i++)
    {
        if ( *text==0)
        {
            term =1;
        }
        matrix[lookup[i]] = ( matrix[lookup[i]] & 0xfffffc00 ) | (term==1? 0 : font_7led [(*text -32)]);
        data[(lookup[i]*2)+1] = (matrix[lookup[i]]>>0 )&0xFF;
        data[(lookup[i]*2)+2] = (matrix[lookup[i]]>>8 )&0xFF;
        text++;
    }
    sendCommand(0x40);                      /* write to display RAM, normal mode, increment address */
    sendBytes  (data, 11);                  /* update ram content */
}

/* =======================================================================
   Name:        init_16seg
   Description: initialize the Front Panel

   ======================================================================== */
static void init_16seg( void )
{
    U8 led[2] = { 0x41, 1 };    /* command 2 : write data to led port */

    sendCommand( 0x00 | 0x00 );
    sendCommand( 0x80 | 0x0F );             /* command 4 : display ON, maximum intensity */
    memset ( &matrix, 0, sizeof(matrix) );

    sendBytes  (led, 2);
}

/* =======================================================================
   Name:        init_7led
   Description: initialize the Front Panel

   ======================================================================== */
static void init_7led( void )
{
    sendCommand( 0x00 | 0x01 );
    sendCommand( 0x80 | 0x0F );             /* command 4 : display ON, maximum intensity */
    memset ( &matrix, 0, sizeof(matrix) );

    set_item_7led(1,1);
}

/* ========================================================================
   Name:        sendReceive
   Description: Send a command byte, followed with a read

   ======================================================================== */
static void sendReceive(U8 Command, U8 *Bytes, U32 num )
{
    U32 i;
    U32 j;
    U32 data;

    SPI_CS(0);
    SPI_DELAY;
    for( i = 0; i < 8; i ++ )
    {
        SPI_SCL(0);
        SPI_DELAY;
        SPI_SDA((Command>>i)&1);
        SPI_SCL(1);
        SPI_DELAY;
    }
    SPI_SET_DATA_IN;
    for (j=0;j<num;j++)
    {
        data=0;
        for(i=0;i<8;i++)
        {
        	SPI_SCL(0);
            SPI_DELAY;
            data |= SPI_READ << i;
            SPI_SCL(1);
            SPI_DELAY;
        }
        *Bytes++ = data;
    }
    SPI_SET_DATA_OUT;
    SPI_CS(1);
    SPI_DELAY;
}

/* ========================================================================
   Name:        read_16seg
   Description: read through the fp controller, the value of the port

   ======================================================================== */
static U8 read_16seg ( void )
{
    U8 dp;
    U8 res;

    res = FP_KEY_NONE;
    sendReceive (0x43, &dp, 1);     /* read switch   */
    res |= (dp & 0x1) ? FP_KEY_NONE : FP_KEY_POWER;
    sendReceive (0x42,&dp, 1);      /* read key data */
    res |= (dp & 0x1) ? FP_KEY_UP   : FP_KEY_NONE;
    res |= (dp & 0x2) ? FP_KEY_DOWN : FP_KEY_NONE;
    return res;
}

/* ========================================================================
   Name:        read_7led
   Description: read through the fp controller, the value of the port

   ======================================================================== */
static U8 read_7led ( void )
{
    U8 dp[5];
    U8 res;

    res = FP_KEY_NONE;
    sendReceive (0x42, dp, 5);      /* read key data */
    res |= (dp[0] & 0x1) ? FP_KEY_UP   : FP_KEY_NONE;
    res |= (dp[0] & 0x8) ? FP_KEY_DOWN : FP_KEY_NONE;
    res |= (dp[1] & 0x1) ? FP_KEY_POWER: FP_KEY_NONE;
    return res;
}

void fp_init( void )
{
    if( board_getConfig(1) & PIO_CONFIG_FP_MASK )
    {
        init_16seg();
        fp.read  = read_16seg;
        fp.write = write_16seg;
    }
    else
    {
        init_7led();
        fp.read  = read_7led;
        fp.write = write_7led;
    }

    fp_write("BOOT");
}
#endif

void fp_write( const I8 *text )
{
    if(fp.write)
    {
        fp.write(text);
    }
}

U8 fp_read_key( void )
{
    if(fp.read)
    {
        return fp.read();
    }
    return FP_KEY_NONE;
}

/* ------------------------------- End of file ---------------------------- */
